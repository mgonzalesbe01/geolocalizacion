<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard - Geolocalización</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      #sidebar {
        width: 300px;
        padding: 20px;
        border-right: 1px solid #ccc;
        background-color: #f9f9f9;
        overflow-y: auto;
      }
      #mapa {
        flex-grow: 1;
        height: 100%;
      }
      form input[type="text"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        box-sizing: border-box;
      }
      ul {
        list-style: none;
        padding-left: 0;
      }
      li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px solid #eee;
      }
      .enlace {
        word-break: break-all;
        cursor: pointer;
        color: blue;
        text-decoration: underline;
      }
      .btn-copiar {
        margin-left: 10px;
        padding: 5px 10px;
        font-size: 12px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="sidebar">
      <!-- Formulario para generar nuevo dispositivo -->
      <h3>Generar Nuevo Enlace</h3>
      <form id="form-generar">
        <input
          type="text"
          name="alias"
          placeholder="Alias (ej: 'Auto', 'Teléfono Juan')"
          required
        />
        <button type="submit">Generar Enlace</button>
      </form>

      <!-- Lista de mis dispositivos + enlaces -->
      <h3>Mis Dispositivos</h3>
      <ul id="lista-dispositivos"></ul>
    </div>

    <!-- Mapa donde se mostrarán las ubicaciones -->
    <div id="mapa"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      const map = L.map("mapa").setView([0, 0], 2);

      // Cambia "pk.tu-token-aqui" por tu token real
      L.tileLayer(
        "https://api.mapbox.com/styles/v1/mapbox/streets-v12/tiles/{z}/{x}/{y}?access_token=pk.tu-token-aqui",
        {
          attribution:
            'Map data &copy; <a href="https://www.mapbox.com/">Mapbox</a>',
          maxZoom: 18,
        }
      ).addTo(map);

      const marcadores = {};

      async function cargarDispositivos() {
        const res = await fetch("/api/dispositivos");
        const data = await res.json();

        document.getElementById("lista-dispositivos").innerHTML = "";
        Object.entries(data).forEach(([codigo, coords]) => {
          const li = document.createElement("li");

          const link = document.createElement("a");
          link.href = "#";
          link.textContent = coords.alias || codigo;

          const eliminarBtn = document.createElement("button");
          eliminarBtn.textContent = "Eliminar";
          eliminarBtn.style.marginLeft = "10px";

          link.onclick = () => {
            // Limpiar todos los marcadores
            Object.values(marcadores).forEach((marker) =>
              map.removeLayer(marker)
            );

            if (coords.lat && coords.lon) {
              marcadores[codigo] = L.marker([coords.lat, coords.lon])
                .addTo(map)
                .bindPopup(
                  `<b>${coords.alias || codigo}</b><br>Lat: ${
                    coords.lat
                  }<br>Lon: ${coords.lon}`
                );
              map.setView([coords.lat, coords.lon], 16);
            }
          };

          eliminarBtn.onclick = () => {
            if (confirm("¿Eliminar este dispositivo?")) {
              fetch(`/eliminar/${codigo}`, { method: "GET" })
                .then(() => location.reload())
                .catch((err) => alert("Error al eliminar"));
            }
          };

          li.appendChild(link);
          li.appendChild(eliminarBtn);
          document.getElementById("lista-dispositivos").appendChild(li);
        });
      }

      setInterval(cargarDispositivos, 5000);
      cargarDispositivos();
    </script>
  </body>
</html>
