<h2>Bienvenido, {{ usuario.nombre }}</h2>

<form id="formDispositivo">
  <input type="text" id="alias" placeholder="Alias del dispositivo" required />
  <button type="submit">Generar Enlace</button>
</form>

<div id="enlaces"></div>

<div id="map" style="height: 90vh; width: 100%"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<script>
  const map = L.map("map").setView([0, 0], 2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  const marcadores = {};

  async function actualizarMarcadores() {
    const res = await fetch("/api/ubicaciones");
    const data = await res.json();

    Object.values(marcadores).forEach((marker) => map.removeLayer(marker));

    for (const [codigo, coords] of Object.entries(data)) {
      if (coords.lat && coords.lon) {
        marcadores[codigo] = L.marker([coords.lat, coords.lon])
          .addTo(map)
          .bindPopup(
            `<b>${
              coords.alias
            }</b><br>Código: ${codigo}<br>Lat: ${coords.lat.toFixed(
              6
            )}<br>Lon: ${coords.lon.toFixed(6)}<br>Precisión: ±${
              coords.precision || 0
            } m`
          );
      }
    }

    if (Object.keys(data).length > 0) {
      const first = Object.values(data)[0];
      map.setView([first.lat, first.lon], 16);
    }
  }

  setInterval(actualizarMarcadores, 5000);
  actualizarMarcadores();

  document
    .getElementById("formDispositivo")
    .addEventListener("submit", async function (e) {
      e.preventDefault();
      const alias = document.getElementById("alias").value;
      const res = await fetch("/registrar-dispositivo", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `alias=${encodeURIComponent(alias)}`,
      });
      const data = await res.json();
      const link = `http://localhost:5000/${data.codigo}`;
      const div = document.createElement("div");
      div.innerHTML = `<strong>${alias}</strong>: <a href="${link}" target="_blank">${link}</a>`;
      document.getElementById("enlaces").appendChild(div);
    });
</script>
