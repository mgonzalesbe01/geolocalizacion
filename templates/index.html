<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Compartiendo Ubicación</title>
    <script>
      const codigo = "{{ codigo }}";

      function enviarUbicacion(lat, lon, accuracy) {
        fetch("/actualizar", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: `codigo=${encodeURIComponent(
            codigo
          )}&latitud=${encodeURIComponent(lat)}&longitud=${encodeURIComponent(
            lon
          )}&precision=${encodeURIComponent(accuracy)}`,
        });
      }

      function getLocation() {
        if (!navigator.geolocation) {
          document.body.innerText = "Geolocalización no soportada";
          return;
        }

        navigator.geolocation.watchPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const precision = position.coords.accuracy;

            enviarUbicacion(lat, lon, precision);
          },
          (error) => {
            document.body.innerText = "Permiso de ubicación denegado";
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0,
          }
        );
      }

      // Registra el Service Worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js").then((registration) => {
          console.log("SW registrado");
        });
      }

      // Solicita permisos de ubicación en segundo plano
      async function requestBackgroundPermission() {
        if ("BackgroundFetchManager" in window) {
          const status = await navigator.permissions.query({
            name: "background-sync",
          });

          if (status.state === "granted") {
            return true;
          }
        }
        return false;
      }

      // Crea un Web Worker para manejar la geolocalización
      const geoWorker = new Worker("/geo-worker.js");

      // Almacena la ubicación en localStorage periódicamente
      setInterval(() => {
        navigator.geolocation.getCurrentPosition((position) => {
          localStorage.setItem(
            "lastLocation",
            JSON.stringify({
              lat: position.coords.latitude,
              lon: position.coords.longitude,
              timestamp: Date.now(),
            })
          );
        });
      }, 10000);

      // Al cargar la página, recupera la última ubicación
      window.addEventListener("load", () => {
        navigator.sendBeacon(
          "/latido",
          `codigo=${encodeURIComponent(codigo)}&desconectado=true`
        );
        const lastLocation = localStorage.getItem("lastLocation");
        if (lastLocation) {
          const location = JSON.parse(lastLocation);
          enviarUbicacion(location.lat, location.lon);
        }
      });

      // Latido más frecuente
      function iniciarLatido() {
        setInterval(() => {
          fetch("/latido", {
            method: "POST",
            body: `codigo=${encodeURIComponent(codigo)}`,
            keepalive: true, // Importantísimo para intentar enviar aunque se cierre
          });
        }, 3000);

        // Intento de último mensaje al cerrar
        window.addEventListener("beforeunload", () => {
          navigator.sendBeacon(
            "/latido",
            `codigo=${encodeURIComponent(codigo)}&desconectando=true`
          );
        });
      }

      window.onload = getLocation;
    </script>
  </head>
  <body>
    <h2>Compartiendo tu ubicación...</h2>
    <p>Código: {{ codigo }}</p>
  </body>
</html>
