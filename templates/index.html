<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Compartiendo Ubicación</title>
    <script>
      const codigo = "{{ codigo }}";

      function enviarUbicacion(lat, lon, accuracy) {
        fetch("/actualizar", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: `codigo=${encodeURIComponent(
            codigo
          )}&latitud=${encodeURIComponent(lat)}&longitud=${encodeURIComponent(
            lon
          )}&precision=${encodeURIComponent(accuracy)}`,
        });
      }

      // Función getLocation mejorada
      function getLocation() {
        const options = {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 10000,
        };

        const watchId = navigator.geolocation.watchPosition(
          (position) => {
            const {
              latitude: lat,
              longitude: lon,
              accuracy: precision,
            } = position.coords;

            // Enviar datos de forma robusta
            const data = new URLSearchParams();
            data.append("codigo", codigo);
            data.append("latitud", lat);
            data.append("longitud", lon);
            data.append("precision", precision);

            fetch("/actualizar", {
              method: "POST",
              body: data,
              keepalive: true, // Permite que la solicitud persista
            }).catch((e) => console.error("Error actualizando:", e));

            // Latido separado
            fetch("/latido", {
              method: "POST",
              body: `codigo=${encodeURIComponent(codigo)}`,
            });
          },
          (error) => {
            console.error("Error geolocation:", error);
          },
          options
        );

        // Limpiar al cerrar
        window.addEventListener("beforeunload", () => {
          navigator.geolocation.clearWatch(watchId);
          navigator.sendBeacon(
            "/latido",
            `codigo=${encodeURIComponent(codigo)}&desconectando=true`
          );
        });
      }

      // Registra el Service Worker
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js").then((registration) => {
          console.log("SW registrado");
        });
      }

      // Solicita permisos de ubicación en segundo plano
      async function requestBackgroundPermission() {
        if ("BackgroundFetchManager" in window) {
          const status = await navigator.permissions.query({
            name: "background-sync",
          });

          if (status.state === "granted") {
            return true;
          }
        }
        return false;
      }

      // Crea un Web Worker para manejar la geolocalización
      const geoWorker = new Worker("/geo-worker.js");

      // Almacena la ubicación en localStorage periódicamente
      setInterval(() => {
        navigator.geolocation.getCurrentPosition((position) => {
          localStorage.setItem(
            "lastLocation",
            JSON.stringify({
              lat: position.coords.latitude,
              lon: position.coords.longitude,
              timestamp: Date.now(),
            })
          );
        });
      }, 10000);

      // Al cargar la página, recupera la última ubicación
      window.addEventListener("load", () => {
        navigator.sendBeacon(
          "/latido",
          `codigo=${encodeURIComponent(codigo)}&desconectado=true`
        );
        const lastLocation = localStorage.getItem("lastLocation");
        if (lastLocation) {
          const location = JSON.parse(lastLocation);
          enviarUbicacion(location.lat, location.lon);
        }
      });

      // Latido más frecuente
      function iniciarLatido() {
        setInterval(() => {
          fetch("/latido", {
            method: "POST",
            body: `codigo=${encodeURIComponent(codigo)}`,
          });
        }, 5000);

        // Intento de último mensaje al cerrar
        window.addEventListener("beforeunload", () => {
          navigator.sendBeacon(
            "/latido",
            `codigo=${encodeURIComponent(codigo)}&desconectando=true`
          );
        });
      }

      window.onload = getLocation;
    </script>
  </head>
  <body>
    <h2>Compartiendo tu ubicación...</h2>
    <p>Código: {{ codigo }}</p>
  </body>
</html>
